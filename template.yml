AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Webhook Lambda for subscription tier synchronization

Parameters:
  WebhookSecret:
    Type: String
    NoEcho: true
  WebhookProvider:
    Type: String
    Default: revenuecat
    AllowedValues:
      - revenuecat
      - stripe

Resources:
  SubscriptionWebhookFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: subscriptionWebhookFunction
      Runtime: nodejs22.x
      Handler: dist/src/subscriptionWebhook.handler
      CodeUri: ./
      MemorySize: 256
      Timeout: 15
      Environment:
        Variables:
          USER_PROFILE_TABLE_NAME: UserProfileTable
          WEBHOOK_EVENTS_TABLE_NAME: WebhookEventsTable
          WEBHOOK_PROVIDER: !Ref WebhookProvider
          WEBHOOK_SECRET: !Ref WebhookSecret
          LOG_LEVEL: info
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
              Resource:
                - !GetAtt UserProfileTable.Arn
                - !GetAtt WebhookEventsTable.Arn
      Events:
        SubscriptionWebhookRoute:
          Type: HttpApi
          Properties:
            ApiId: !Ref WebhookHttpApi
            Method: POST
            Path: /subscription-webhook

  WebhookHttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: prod
      Auth:
        EnableIamAuthorizer: false
      CorsConfiguration:
        AllowMethods:
          - POST
          - OPTIONS
        AllowOrigins:
          - "*"

  UserProfileTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: UserProfileTable
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST

  WebhookEventsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: WebhookEventsTable
      AttributeDefinitions:
        - AttributeName: eventId
          AttributeType: S
      KeySchema:
        - AttributeName: eventId
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
